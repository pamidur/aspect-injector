<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask Condition="'$(AspectInjector_Location)' != ''" TaskName="AspectInjectorTask" AssemblyFile="$(AspectInjector_Location)" />
  <UsingTask Condition="'$(AspectInjector_Location)' == ''" TaskName="AspectInjectorTask" AssemblyFile="(MSBuildThisFileDirectory)../../binaries/AspectInjector.dll" />

  <ItemGroup>
    <PackageReference Update="AspectInjector" PrivateAssets="None" />
  </ItemGroup>

  <PropertyGroup>
    <AspectInjector_Enabled Condition="'$(AspectInjector_Enabled)' == ''">true</AspectInjector_Enabled>
    <AspectInjector_Debug Condition="'$(AspectInjector_Debug)' == ''">false</AspectInjector_Debug>
    <AspectInjector_Verbose Condition="'$(AspectInjector_Verbose)' == ''">false</AspectInjector_Verbose>
  </PropertyGroup>

  <PropertyGroup>
    <_InjectAspectsDependsOn>
      AspectInjector_InjectAspectsCore;
    </_InjectAspectsDependsOn>
  </PropertyGroup>

  <Target Name="AspectInjector_InjectAspects" 
          AfterTargets="CoreCompile" 
          BeforeTargets="_TimeStampAfterCompile;AfterCompile" 
          Condition="'$(AspectInjector_Enabled)' == 'true'" 
          DependsOnTargets="$(_InjectAspectsDependsOn)"
  />

  <Target Name="AspectInjector_InjectAspectsCore"
          Inputs="@(IntermediateAssembly->'%(FullPath)')" 
          Outputs="%(IntermediateAssembly.FullPath).aspectsinjected"
    >
    <AspectInjectorTask 
      AssemblyPath="@(IntermediateAssembly->'%(FullPath)')" 
      References="@(ReferencePath)"
      Optimize="$(Optimize)"
      AttachDebugger="$(AspectInjector_Debug)"
      Verbose="$(AspectInjector_Verbose)"
    />
    <Touch Files="%(IntermediateAssembly.FullPath).aspectsinjected" AlwaysCreate="true" Time="%(IntermediateAssembly.ModifiedTime)"/>
  </Target>

</Project>

